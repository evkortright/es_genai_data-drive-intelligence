[.text-4xl]
[.text-white]
== 1 - Introduction to Painless
image::blue-background.png[background, size=cover]

[.text-3xl]
== The Painless Language
image::white-background.png[background, size=cover]

* **Painless** was designed and developed specifically for Elasticsearch
** It is fast and secure
** It has a Groovy-like syntax
** It supports all of Java’s data types
** It exposes many Java classes (e.g., Math) and methods
* As of Elasticsearch 6.0,  Painless is the only scripting language supported
** Other languages, including Groovy, Javascript, and Python are no longer available

[.text-3xl]
== Basics of Painless Scripting
image::white-background.png[background, size=cover]

* In this lesson you will learn to write basic scripts using Painless:
** Script syntax
** Single-line expressions
** Script Parameters
** Statements and blocks
** Primitive data types
** Variables
** Conditionals
** Methods

[.text-3xl]
== Getting Started
image::white-background.png[background, size=cover]

* We can start writing and running scripts using the `_scripts` API with the `_execute` end-point:

```
include::../code/evaluate_expression.painless[]
```

* The source code in this case is simply an single-line numerical expression

* Note the use of JSON to encapsulate the script — everything in Elasticsearch is in JSON!

* Go ahead, try out the script and write a few variations!

[.text-3xl]
== Code Blocks
image::white-background.png[background, size=cover]

* Writing complex code as an inline expression is not very practical

* We can write blocks of code using `"""` as the block delimiter

* Using a code block, the previous script would now be:

```
include::../code/evaluate_expression_code_block.painless[]
```

[.text-3xl]
== Variables and Types
image::white-background.png[background, size=cover]

* Variables in Painless can be declared by specifing their type, name, and initial value

```
include::../code/declaring_variables.painless[]
```

[.text-2xl]
== Data Types
image::white-background.png[background, size=cover]

* Painless has the same data types as Java, including
** Primitive types: `byte`, `char`, `short`, `int`, `long`, `float`, `double`, and `boolean`

** Object wrappers for primitive types: `Integer`, `Long`, `Float`, `Double`, and `Boolean`

** `String`

** Other object types, including
*** `Date`

*** and others

** Data structures
*** Arrays, Lists, Maps, and others — which we will cover in depth in the *Advanced Painless* course

*** Lists

*** Maps

[.text-2xl]
== Expressions
image::white-background.png[background, size=cover]

* You can write numerical expressions using +, -, *, / and %
** Be aware that `4/3` is not the same expression as `4.0/3.0` (why?)

** You can also use bitwise operators `&` (and), `|` (or), `^` (xor), `<<` (shift left), `>>` (shift right) — which will be very useful in the advanced course

* For boolean expressions use `==`, `>`, `<`, `>=`, `<=`, `&&`, `||`, and `!`

* For string expressions you can use `+` (concatenation)
** Note that using `+` to concatenate a string with a non-string value will coerce this value into a string as part of the concatenation

* You can use parentheses to create sub-expressions and control the order of evaluation

* This is all familiar territory to you as a programmer!

[.text-3xl]
== An Example
image::white-background.png[background, size=cover]

[.text-left]
* Can you figure out the output of the following script before you run it?

```
include::../code/figure_it_out.painless[]
```

[.text-left]
* Did you note anything interesting with the average score?
** Try dividing by `3.0`, instead of `3`

[.text-2xl]
== Maps and ArrayLists
image::white-background.png[background, size=cover]

* In Painless, Maps and ArrayLists are particularly easy to build and use — so let’s start working with them

** `m = ["a": 1, "b": 2]` creates a Map `m` containing two keys, `"a"` and `"b"` with values `1` and `2`, respectively

*** `m.get("a")` returns `1`, the value of key `"a"`

*** `m.put("c": 3)` adds a new key `"c"` to m with a value of `3`

*** `m.remove("a")` removes the entry in the Map with a key of `"a"`

** `a = [1, 2]` creates an `ArrayList a` containing two values, `1` and `2`, in that order

*** `a[0]` returns `1`, while `a[1]` returns `2`

*** `a.add(3)` adds `3` to the end of `a`

*** `a.remove(2)` removes the element at position `2` from `a`, shifting the remaining elements to the left

[.text-2xl]
== Maps and ArrayLists (continued)
image::white-background.png[background, size=cover]

[.text-left]
* This script generates the multiplication table for m (going up to m*n) as an ArrayList and puts it in a Map with m as the key — try it!

```
include::../code/mult_table.painless[]
```

[.text-left]
** The output for the parameters used should be
```
include::../code/mult_table_result.painless[]
```

[.text-2xl]
== Script Parameters
image::white-background.png[background, size=cover]

* To make scripts more general and efficient, we can use *script parameters*

** Values that change from one execution to another should be passed as parameters

** The compiled version of the source will be cached by ES and can be reused with new data

```
include::../code/script_parameters.painless[]
```

[.text-2xl]
== Conditional Statements
image::white-background.png[background, size=cover]

[.text-left]
* Painless supports `if` and `if-else` conditional statements

```
include::../code/conditional_statements.painless[]
```

[.text-left]
** Interestingly, Painless does not support `switch` statements!

[.text-2xl]
== The Conditional Operator
image::white-background.png[background, size=cover]

* Instead of using an if-statement to set the value of a variable, we can use the conditional operator ?

```
include::../code/conditional_operator.painless[]
```

[.text-3xl]
== Loops
image::white-background.png[background, size=cover]

* Painless supports `for`, `while`, `do-while`, and _for-each_ loops
** In the `do-while`, the condition is evaluated at the end of each iteration — which means it will be run at least once

[.text-2xl]
[.columns]
== COMPARE THESE LOOPS
image::white-background.png[background, size=cover]

[.text-2xl]
[.column]
```
include::../code/three_loop_constructs_for.painless[]
```

[.column]
```
include::../code/three_loop_constructs_do.painless[]
```

[.column]
```
include::../code/three_loop_constructs_while.painless[]
```

[.text-2xl]
[.columns]
== Foreach Iteration
image::white-background.png[background, size=cover]

[.column]
```
include::../code/120_foreach_version1.painless[]
```

[.column]
```
include::../code/125_foreach_version2.painless[]
```

[.text-2xl]
== Methods
image::white-background.png[background, size=cover]

[.text-left]
* Methods and functions (methods that return values) are supported inside Painless scripts

* This script contains a function that finds the area of a circle of radius `r`

```
include::../code/methods.painless[]
```

[.text-left]
* Methods allow us to write reusable Painless code

* Unfortunately, methods cannot be saved outside a script and must be copy-pasted from script to script

[.text-2xl]
== Putting together what we know so far
image::white-background.png[background, size=cover]

[.text-left]
* Consider the following document containing an array of configuration items:

```
include::../code/135_config_items_to_resources_config_items.painless[]
```
[.text-2xl]
== Putting together (continued)
image::white-background.png[background, size=cover]

[.text-left]
* We may want to extract field-value pairs from the array of nested objects.
For example, we may want to pair `resourceId` with `type` in preparation for indexing:

```
include::../code/137_config_items_to_resources_resources.painless[]
```
[.text-2xl]
== Putting together (continued)
image::white-background.png[background, size=cover]

[.text-left]
* To solve it we can iterate through the nested objects using a _for-each_ loop.
We can create a new Map to hold the output.
We can use the `getOrDefault` method from the `Map` Java API to not only retrieve
a element by key one of the config objets, but to also create a default value when
no value is found for that key.
Finally, we can encapsulate the solution logic in a function for clarity and reuse.

```
include::../code/130_config_items_to_resources.painless[]
```

[.text-3xl]
== Storing a Script
image::white-background.png[background, size=cover]

[.text-left]
* A Painless script can be stored in the cluster state using the `_script` API and giving it a name (its id)

```
include::../code/storing_a_script.painless[]
```

[.text-left]
** Later on, during an Elasticsearch operation, such as search or update, the script can be invoked by id with parameters values passed on invocation — we’ll use this feature in a later lesson

[.text-4xl]
[.text-white]
== Summary
image::blue-background.png[background, size=cover]

[.text-3xl]
== Summary
image::white-background.png[background, size=cover]

* Painless was developed specifically for Elasticsearch to be a secure and efficient scripting language

* Painless has the same data types as Java and exposes many Java API’s

* Script parameters should be in order to make a script more general — and to reuse the cached compilation with new data

* Painless supports most programming constructs, including conditionals and loops, but does not support switch statements 

* Painless supports methods inside scripts

* Scripts can be stored in the cluster state and later on invoked by id and with new parameter values

[.text-3xl]
== Quiz
image::white-background.png[background, size=cover]

. **True or False**: Python can be used for scripting in Elasticsearch

. Name three advantages of Painless

. **True or False**: Painless supports the `switch` statement

. **True or False**: Painless scripts are cached by Elasticsearch

. **True or False**: `while` and `do-while` work exactly in the same way in Painless

[.text-3xl]
=== Quiz Answers
image::white-background.png[background, size=cover]

. **False**
. Fast, secure, supports all Java data types, exposes many Java API’s, Groovy-like syntax
. **False**
. **True**
. **False**. `while` evaluates the condition at the beginning of the block and `do-while` evaluates it at the end (so it executes the block at least once) 


[.text-4xl]
[.text-white]
== Lab 1: Introduction to Painless
image::green-background.png[background, size=cover]
